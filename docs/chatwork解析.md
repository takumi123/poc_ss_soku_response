# Chatworkメッセージ解析仕様



## データ構造

提供されたデータはメッセージのリストで、各メッセージには以下の情報が含まれます：

- **message_id**: メッセージの一意の識別子
- **account**: 送信者のアカウント情報
  - account_id
  - name
- **body**: メッセージ本文
- **send_time**: メッセージの送信時刻（Unixタイムスタンプ）

### メッセージ形式

メッセージ本文には特定の形式で返信や宛先の情報が埋め込まれています：

- 返信形式: `[rp aid=6266294 to=304374174-1863047052540268544]`
  - aid: 返信先のアカウントID
  - to: 返信先のメッセージID
- 宛先形式: `[To:6266294]`
  - 特定のユーザーへの宛先を示す

## システム目的

ToまたはReが付いたメッセージで、3時間以内に返信がない場合にリマインドを送信するシステムを構築します。

## データベース設計

### accounts（アカウント）テーブル
| カラム名 | 型 | 説明 |
|----------|-----|------|
| account_id | INT | 主キー |
| name | VARCHAR | アカウント名 |

### messages（メッセージ）テーブル
| カラム名 | 型 | 説明 |
|----------|-----|------|
| message_id | BIGINT | 主キー |
| account_id | INT | 外部キー（送信者のアカウントID） |
| body | TEXT | メッセージ本文 |
| send_time | TIMESTAMP | 送信時刻 |

### message_relations（メッセージ関係）テーブル
| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | INT | 主キー |
| message_id | BIGINT | 外部キー（このメッセージのID） |
| related_account_id | INT | 関連するアカウントID |
| related_message_id | BIGINT | 関連するメッセージID |
| type | ENUM | 'To'または'Re' |

## API設計

### 未返信メッセージの取得API
- **エンドポイント**: GET /api/unreplied_messages
- **クエリパラメータ**:
  - time_frame（オプション）: 未返信とみなす時間枠（デフォルト3時間）
- **レスポンス**: 未返信メッセージのリスト

### リマインド送信API
- **エンドポイント**: POST /api/send_reminder
- **ボディパラメータ**:
  - message_id: リマインド対象のメッセージID
- **レスポンス**: リマインド送信の結果

## 処理フロー

### 1. メッセージの保存時
1. メッセージ本文をパースしてToやRe情報を抽出
2. message_relationsテーブルに関係性を保存

### 2. 未返信メッセージのチェック
- 10分ごとに以下の条件でメッセージを検索
  - 指定時間枠以上前に送信
  - 関連する返信が存在しない
- 該当メッセージに対してリマインドを送信

### 3. リマインドの送信
- リマインド対象ユーザーに通知を送信
  - メール
  - アプリ内通知

## 実装上の注意点

- メッセージ本文のパースには正規表現を使用
- 時刻比較はUTCで統一
- 必要に応じてremindersテーブルを追加して送信履歴を管理


1. toかreplyがついた人にリマインドメールが送られる。
2. 複数ついた場合は最初についている人に送られる。
3. ChatGPTでメッセージの緊急度、返信が必要かどうかを判定し、返信が必要なら送信する。
4. 返信をする形でメッセージを送ること。返信しない場合はメッセージの送信を検知できないため。
5. 自分宛のToがついた投稿が来て3時間以内に投稿が削除された場合は即レスくんからメッセージは来ない
6. 自分宛のReがついた投稿が来て3時間以内に投稿が削除された場合は即レスくんからメッセージは来ない
7. Toが二連続など、重複登録されている場合は一度返信すれば即レスくんからメッセージは来ない

7の実現方法
1. メッセージの紐付けとステータス管理
アプローチ:

メッセージごとにステータスを管理する。
ステータス例: 未返信、返信済み、削除済み
ユーザーごとに未返信のメッセージ一覧を保持する。
具体的な手順:

未返信メッセージの収集:

データベースで、各ユーザーに対する未返信のTo/Re付きメッセージを取得します。
返信の検知:

ユーザーが返信した場合、そのメッセージの message_id を取得します。
返信元のメッセージ（related_message_id）を特定し、ステータスを「返信済み」に更新します。
関連する未返信メッセージの更新:

返信があった場合、そのユーザーに対する他の未返信メッセージも「返信済み」に更新します。
これにより、一度の返信でそのユーザーに対する全てのリマインドを止めることができます。
ポイント:

ユーザー単位で未返信メッセージを管理することで、一度の返信でリマインドを停止できる。
返信がどのメッセージに対するものであるかを正確に特定することが重要。

---

memo
- roomごとにリマインド時間を変えることができる。
- リマインド時間は30分、1時間、3時間の3種類。
- リマインド時間はデフォルトで3時間になっている。
- 即レスくんにログインできる人だけがAPIキー発行すれば良い。1組織1回だけの作業。

- 即レスくんと友達になる必要あり。
- コンタクトの申請はできないが、承認はAPIで自動でできる。
https://developer.chatwork.com/reference/get-incoming_requests

---
## Chatworkのroomから取得したデータサンプル

{"messages":[{"message_id":"1860640822840524800","account":{"account_id":5812064,"name":"蓑輪弘太"},"body":"[rp aid=6266294 to=304374174-1860640206227525632]遠藤巧巳さん\nご確認ありがとうございます。\nかしこまりました。\n\nでは、このあと給与明細を基に源泉所得税の金額を集計してまいります。\n（本日、弊社古川より誤った案内があり、申し訳ございませんでした。）\n\n正式な金額をご案内差し上げますので、今しばらくお待ちくださいませ。\n\nどうぞよろしくお願いいたします。","send_time":1720084941},{"message_id":"1860641634476118016","account":{"account_id":5812064,"name":"蓑輪弘太"},"body":"[deleted]","send_time":1720085134},{"message_id":"1860958150811738112","account":{"account_id":5584064,"name":"税理士法人アピロ【0797-61-4512】"},"body":"[deleted]","send_time":1720160598},{"message_id":"1862034061514506240","account":{"account_id":8301552,"name":"水内良子"},"body":"[To:6266294]遠藤巧巳さん\nお世話になっております。\n\n2024年上期の源泉所得税の納付金額が確定いたしましたのでご案内いたします。\n\n金額をご確認いただき、問題なければ7/10付の納付手続きを行いますので、おっしゃっていただければと存じます。\n\nご確認のほど、よろしくお願いいたします。\n[info][title][dtext:file_uploaded][/title][preview id=1510802065 ht=83][download:1510802065]image_2024_7_8.png (292.53 KB)[/download][/info]","send_time":1720417115},{"message_id":"1862047908623286272","account":{"account_id":6266294,"name":"遠藤巧巳"},"body":"[rp aid=8301552 to=304374174-1862034061514506240]古川郁子さん\n確認しました。問題ありません。","send_time":1720420416},